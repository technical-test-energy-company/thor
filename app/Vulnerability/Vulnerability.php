<?php

namespace App\Vulnerability;

use App\Asset\Asset;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Support\Str;
use Infrastructure\Constants\Constants;
use Infrastructure\Enums\RiskSeverity;
use Infrastructure\Model\BaseModel;

class Vulnerability extends BaseModel
{
    use HasFactory;

    public const TABLE_NAME = 'vulnerabilities';

    private const ID_PREFIX = 'v';

    protected $fillable = [
        Constants::CVE_ID,
        Asset::FOREIGN_ID,
        'severity',
        'description',
        'date_published',
        'scope',
        'refId',
        'cvss',
        'acknowledged',
    ];

    protected $casts = [
        'severity' => RiskSeverity::class,
        'date_published' => 'datetime',
        'cvss' => 'float',
        'acknowledged' => 'boolean',
    ];

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function ($vulnerability): void {
            $vulnerability->uid = Str::uuid();
        });

        static::created(function ($vulnerability): void {
            $vulnerability->uid = self::ID_PREFIX.$vulnerability->id;
            $vulnerability->saveQuietly();
        });
    }
}
