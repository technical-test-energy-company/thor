<?php

namespace App\Vulnerability;

use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Foundation\Queue\Queueable;
use Illuminate\Support\Facades\Config;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;
use Infrastructure\Exceptions\NvdExternalApi\NvdApiMissingFieldsException;
use Infrastructure\Exceptions\NvdExternalApi\NvdApiNoResultsException;
use Throwable;

class VulnerabilityEnrichmentJob implements ShouldQueue
{
    use Dispatchable, Queueable;

    private Vulnerability $vulnerability;

    public function __construct(Vulnerability $vulnerability)
    {
        $this->vulnerability = $vulnerability;
    }

    public function handle(VulnerabilityService $vulnerabilityService): void
    {
        $baseUrl = Config::get('services.nvd.base_url');
        $cveId = $this->vulnerability->cve_id;
        $url = "$baseUrl?cveId=$cveId";

        try {
            $response = Http::retry(2, 200)
                ->get($url)
                ->throw()
                ->json();

            $results = $response['totalResults'] ?? 0;
            if (0 === $results) {
                throw new NvdApiNoResultsException($cveId, $response);
            }

            $newData = $this->getVulnerabilityNewData($response, $cveId);
            $vulnerabilityService->update($newData, $this->vulnerability);
        } catch (Throwable $error) {
            // TODO: add new log here
            Log::debug($error->getMessage());
        }
    }

    private function getVulnerabilityNewData(array $data, string $cveId): array
    {
        $cveData = $data['vulnerabilities'][0]['cve'] ?? null;
        $published = $cveData['published'] ?? null;
        $description = collect($cveData['descriptions'] ?? [])->firstWhere('lang', 'en')['value'] ?? null;
        $metric = $cveData['metrics']['cvssMetricV2'][0] ?? null;
        $severity = $metric['baseSeverity'] ?? null;
        $score = $metric['impactScore'] ?? null;

        $data = [
            'date_published' => $published,
            'description' => $description,
            'severity' => Str::lower($severity),
            'cvss' => $score,
        ];

        $anyFieldIsNull = collect([$published, $description, $severity, $score])->contains(null);
        if ($anyFieldIsNull) {
            throw new NvdApiMissingFieldsException($cveId, $data);
        }

        return $data;
    }
}
