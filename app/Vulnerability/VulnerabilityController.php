<?php

namespace App\Vulnerability;

use App\Vulnerability\Requests\StoreVulnerabilityRequest;
use App\Vulnerability\Requests\UpdateVulnerabilityRequest;
use Dedoc\Scramble\Attributes\QueryParameter;
use Infrastructure\Http\Controllers\Controller;
use Infrastructure\Http\Requests\IndexRequest;
use Symfony\Component\HttpFoundation\Response;

class VulnerabilityController extends Controller
{
    private VulnerabilityService $vulnerabilityService;

    public function __construct(VulnerabilityService $vulnerabilityService)
    {
        $this->vulnerabilityService = $vulnerabilityService;
    }

    /**
     * List all available Vulnerabilities.
     *
     * @response array{data: Vulnerability[], path: string, per_page: int, next_cursor: string|null, next_page_url: string|null, prev_cursor: string|null, prev_page_url: string|null}
     */
    #[QueryParameter('limit', default: IndexRequest::DEFAULT_LIMIT)]
    public function index(IndexRequest $request): Response
    {
        $data = $request->validated();
        $response = $this->vulnerabilityService->index($data);

        return response($response);
    }

    /**
     * Create a new Vulnerability and kick off the enrichment process with the NVD API.
     */
    public function store(StoreVulnerabilityRequest $request): Response
    {
        $data = $request->validated();
        $response = $this->vulnerabilityService->store($data);

        /**
         * @status 201
         *
         * @body Vulnerability
         */
        return response($response, Response::HTTP_CREATED);
    }

    /**
     * Retrieve a Vulnerability.
     */
    public function show(Vulnerability $vulnerability): Response
    {
        return response($vulnerability);
    }

    /**
     * Update a Vulnerability.
     */
    public function update(UpdateVulnerabilityRequest $request, Vulnerability $vulnerability): Response
    {
        $data = $request->validated();
        $response = $this->vulnerabilityService->update($data, $vulnerability);

        /**
         * @body Vulnerability
         */
        return response($response);
    }

    /**
     * Delete a Vulnerability.
     */
    public function destroy(Vulnerability $vulnerability): Response
    {
        $user = auth('sanctum')->user();
        $this->vulnerabilityService->destroy($vulnerability, $user);

        return response()->noContent();
    }
}
